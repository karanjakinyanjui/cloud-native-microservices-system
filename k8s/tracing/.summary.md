# Jaeger Distributed Tracing Setup - Creation Summary

## Overview

Created a comprehensive Jaeger distributed tracing setup for cloud-native microservices system at `/home/user/cloud-native-microservices-system/k8s/tracing/`

**Total Files Created**: 25
**Total Lines**: 4,191

## Directory Structure

```
k8s/tracing/
├── README.md                              # Comprehensive documentation
├── kustomization.yaml                     # Kustomize configuration
├── jaeger-all-in-one.yaml                # Development/testing deployment
├── configmap.yaml                         # Jaeger configuration & sampling
├── hpa.yaml                              # HorizontalPodAutoscaler configs
├── networkpolicy.yaml                     # Network security policies
├── servicemonitor.yaml                    # Prometheus ServiceMonitor & alerts
│
├── jaeger-production/                     # Production deployment
│   ├── collector-deployment.yaml         # Collector (3 replicas)
│   ├── collector-service.yaml            # Collector service & headless
│   ├── query-deployment.yaml             # Query/UI (2 replicas)
│   ├── query-service.yaml                # Query service & ingress
│   ├── agent-daemonset.yaml              # Agent on every node
│   ├── agent-service.yaml                # Agent service
│   └── kustomization.yaml                # Production kustomize
│
├── elasticsearch/                         # Trace storage backend
│   ├── statefulset.yaml                  # ES cluster (3 nodes)
│   ├── service.yaml                      # ES services (ClusterIP & headless)
│   ├── configmap.yaml                    # ES config & curator
│   ├── pvc.yaml                          # Storage documentation
│   └── kustomization.yaml                # ES kustomize
│
├── jaeger-operator/                       # Operator-based deployment
│   ├── jaeger-cr.yaml                    # CustomResource definitions
│   └── README.md                         # Operator installation guide
│
└── examples/                              # Instrumentation examples
    ├── service-instrumentation.yaml      # Example deployments
    ├── test-trace.json                   # Sample trace data
    ├── test-trace.sh                     # Testing script
    └── README.md                         # Examples documentation
```

## Key Features

### 1. All-in-One Deployment (Development)
- **File**: `jaeger-all-in-one.yaml`
- Single pod with collector, query, and agent
- Badger embedded storage with 20Gi PVC
- 7-day trace retention
- Prometheus metrics integration
- Quick setup for development/testing

**Deployment**:
```bash
kubectl apply -f jaeger-all-in-one.yaml
kubectl port-forward svc/jaeger-query 16686:16686
```

### 2. Production Setup (Scalable)
- **Directory**: `jaeger-production/`
- **Components**:
  - **Collector**: 3 replicas, auto-scaling (3-10), resource limits
  - **Query**: 2 replicas, ingress support, Grafana integration
  - **Agent**: DaemonSet on every node, low overhead
- **Features**:
  - Pod anti-affinity for HA
  - Elasticsearch backend
  - gRPC and HTTP protocols
  - OTLP support (OpenTelemetry)

**Deployment**:
```bash
kubectl apply -f elasticsearch/
kubectl wait --for=condition=ready pod -l app=elasticsearch --timeout=600s
kubectl apply -f jaeger-production/
```

### 3. Elasticsearch Storage
- **Directory**: `elasticsearch/`
- 3-node cluster with 100Gi storage per node
- Index lifecycle management
- Automated cleanup with Curator CronJob
- Configurable retention (default: 7 days)
- Optimized for trace workloads

### 4. Configuration Management
- **File**: `configmap.yaml`
- **Includes**:
  - Adaptive sampling strategies per service
  - Collector configuration (workers, queue size)
  - Agent configuration (UDP ports, batching)
  - UI configuration (Grafana links, custom views)
  - Index cleanup automation (Curator)
  - Elasticsearch credentials

**Sampling Strategies**:
- user-service: 50%
- product-service: 50%
- order-service: 80%
- payment-service: 100%
- inventory-service: 50%
- notification-service: 30%

### 5. Observability Integration

#### Prometheus Metrics
- **File**: `servicemonitor.yaml`
- ServiceMonitors for all Jaeger components
- 13 PrometheusRule alerts including:
  - Collector down/high drop rate
  - Query latency issues
  - Elasticsearch health
  - Storage capacity warnings
  - Low tracing coverage

#### Grafana Integration
- Jaeger data source configuration
- Trace-to-logs linking
- Span metrics export
- Custom dashboard examples

### 6. High Availability & Scaling
- **File**: `hpa.yaml`
- Auto-scaling for collector (3-10 replicas)
- Auto-scaling for query (2-5 replicas)
- CPU, memory, and custom metrics triggers
- Graceful scale-down policies

### 7. Security
- **File**: `networkpolicy.yaml`
- Network policies for all components
- Ingress/egress restrictions
- Service-to-service communication control
- Elasticsearch access control
- Basic auth support for UI

### 8. Operator Support
- **Directory**: `jaeger-operator/`
- CustomResource definitions for production and simple deployments
- Declarative Jaeger management
- Auto-scaling and self-healing
- Installation guide with prerequisites

### 9. Service Instrumentation
- **Directory**: `examples/`
- Examples for Go, Python, Node.js, Java
- Environment variable configurations
- Sidecar pattern examples
- Direct collector submission
- HTTP header propagation
- Testing scripts and sample data

## Deployment Options

### Option 1: All-in-One (Development)
```bash
kubectl apply -f k8s/tracing/jaeger-all-in-one.yaml
```
- Best for: Development, testing, demos
- Resources: 512Mi-2Gi memory, 500m-2000m CPU
- Storage: 20Gi (7-day retention)

### Option 2: Production (Manual)
```bash
kubectl apply -f k8s/tracing/elasticsearch/
kubectl apply -f k8s/tracing/jaeger-production/
kubectl apply -f k8s/tracing/configmap.yaml
kubectl apply -f k8s/tracing/hpa.yaml
kubectl apply -f k8s/tracing/networkpolicy.yaml
kubectl apply -f k8s/tracing/servicemonitor.yaml
```
- Best for: Production environments
- Resources: 4-8 replicas, 300Gi storage
- High availability and auto-scaling

### Option 3: Kustomize (Recommended)
```bash
kubectl apply -k k8s/tracing/jaeger-production/
```
- Best for: GitOps workflows
- Declarative configuration
- Environment-specific overlays

### Option 4: Operator (Advanced)
```bash
# Install operator
kubectl create namespace observability
kubectl apply -n observability -f https://github.com/jaegertracing/jaeger-operator/releases/download/v1.51.0/jaeger-operator.yaml

# Deploy Jaeger
kubectl apply -f k8s/tracing/jaeger-operator/jaeger-cr.yaml
```
- Best for: Advanced users, multiple Jaeger instances
- Self-healing and auto-upgrade
- Requires cert-manager

## Service Endpoints

### All-in-One Deployment
- **UI**: `http://jaeger-query:16686`
- **Collector (gRPC)**: `jaeger-collector:14250`
- **Collector (HTTP)**: `jaeger-collector:14268`
- **Agent (UDP)**: `jaeger-agent:6831`
- **OTLP (gRPC)**: `jaeger-collector:4317`
- **OTLP (HTTP)**: `jaeger-collector:4318`
- **Zipkin**: `jaeger-collector:9411`

### Production Deployment
Same endpoints with multiple replicas and load balancing.

## Environment Variables for Services

Add to your microservice deployments:

```yaml
env:
- name: JAEGER_AGENT_HOST
  value: "jaeger-agent"
- name: JAEGER_AGENT_PORT
  value: "6831"
- name: JAEGER_SAMPLER_TYPE
  value: "probabilistic"
- name: JAEGER_SAMPLER_PARAM
  value: "0.5"
```

## Resource Requirements

### All-in-One
- **CPU**: 500m request, 2000m limit
- **Memory**: 512Mi request, 2Gi limit
- **Storage**: 20Gi

### Production Total
- **Collector**: 3×(1Gi-4Gi) = 3-12Gi memory
- **Query**: 2×(512Mi-2Gi) = 1-4Gi memory
- **Agent**: N×(128Mi-512Mi) per node
- **Elasticsearch**: 3×(4Gi-8Gi) = 12-24Gi memory
- **Storage**: 3×100Gi = 300Gi

## Key Configuration Files

1. **jaeger-all-in-one.yaml** (366 lines)
   - Complete all-in-one deployment
   - ConfigMap with sampling
   - PVC for storage
   - All services

2. **configmap.yaml** (324 lines)
   - Sampling strategies
   - Collector configuration
   - Agent configuration
   - UI configuration
   - Curator cleanup
   - CronJob for index cleanup

3. **elasticsearch/statefulset.yaml** (146 lines)
   - 3-node cluster
   - Init containers
   - Volume claims
   - Anti-affinity rules

4. **README.md** (989 lines)
   - Comprehensive documentation
   - Installation guides
   - Instrumentation examples
   - Query examples
   - Grafana integration
   - Troubleshooting
   - Best practices

## Testing

### Quick Test
```bash
# Port forward services
kubectl port-forward svc/jaeger-query 16686:16686 &
kubectl port-forward svc/jaeger-collector 14268:14268 &

# Submit test trace
cd examples
chmod +x test-trace.sh
./test-trace.sh

# View in UI
open http://localhost:16686
```

### Verify Deployment
```bash
# Check all components
kubectl get all -l app=jaeger

# Check Elasticsearch
kubectl get statefulset elasticsearch
kubectl exec -it elasticsearch-0 -- curl http://localhost:9200/_cluster/health?pretty

# Check metrics
kubectl port-forward svc/jaeger-collector 14269:14269
curl http://localhost:14269/metrics | grep spans_received
```

## Integration Points

### 1. Microservices
- Add Jaeger client libraries
- Configure environment variables
- Instrument HTTP/gRPC handlers
- Propagate trace context

### 2. Prometheus
- ServiceMonitors for auto-discovery
- Span metrics export
- PrometheusRules for alerting
- Grafana dashboards

### 3. Grafana
- Jaeger data source
- Trace exploration
- Logs correlation
- Custom dashboards

### 4. Service Mesh (Istio/Linkerd)
- Automatic trace generation
- Header propagation
- Span enrichment
- Skip outbound ports annotation

## Monitoring & Alerts

**PrometheusRule Alerts**:
- JaegerCollectorDown (critical)
- JaegerCollectorHighSpanDropRate (warning)
- JaegerCollectorQueueFull (warning)
- JaegerCollectorHighMemory (warning)
- JaegerQueryDown (warning)
- JaegerQueryHighLatency (warning)
- ElasticsearchJaegerClusterDown (critical)
- ElasticsearchJaegerDiskSpaceHigh (warning)
- LowTracingCoverage (info)

## Maintenance

### Index Cleanup
Automated via CronJob (daily at 23:55):
```bash
# Manual trigger
kubectl create job --from=cronjob/jaeger-es-index-cleaner manual-cleanup
```

### Backup
```bash
# Elasticsearch snapshot
kubectl exec -it elasticsearch-0 -- curl -X PUT "localhost:9200/_snapshot/backup/snapshot_1?wait_for_completion=true"
```

### Scaling
```bash
# Scale collector
kubectl scale deployment jaeger-collector --replicas=5

# Scale query
kubectl scale deployment jaeger-query --replicas=3

# Scale Elasticsearch
kubectl scale statefulset elasticsearch --replicas=5
```

## Documentation

- **Main README**: Comprehensive guide with all features
- **Operator README**: Operator installation and usage
- **Examples README**: Instrumentation guides for all languages

## Best Practices Implemented

1. **High Availability**: Multiple replicas, anti-affinity rules
2. **Auto-scaling**: HPA for dynamic load handling
3. **Security**: Network policies, secrets management
4. **Observability**: Metrics, logging, alerting
5. **Resource Management**: Requests/limits, quotas
6. **Storage Management**: Automated cleanup, retention policies
7. **Performance**: Batching, compression, efficient sampling
8. **Documentation**: Inline comments, comprehensive guides

## Next Steps

1. **Deploy**: Choose deployment option and apply
2. **Instrument**: Add Jaeger client to microservices
3. **Configure**: Adjust sampling rates per service
4. **Monitor**: Set up Grafana dashboards and alerts
5. **Optimize**: Tune resources based on actual load
6. **Secure**: Enable authentication, TLS, RBAC

## Support Resources

- Jaeger Documentation: https://www.jaegertracing.io/docs/
- OpenTracing Spec: https://opentracing.io/specification/
- Jaeger GitHub: https://github.com/jaegertracing/jaeger
- Examples directory: Language-specific instrumentation guides
