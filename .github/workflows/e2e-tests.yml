name: End-to-End Tests

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        type: choice
        options:
          - staging
          - production
          - test
      test_suite:
        description: 'Test suite to run'
        required: false
        type: choice
        options:
          - all
          - smoke
          - regression
          - performance
        default: 'all'

env:
  NODE_VERSION: '20.x'

jobs:
  setup-test-environment:
    name: Setup Test Environment
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'test' || github.event_name == 'schedule'
    outputs:
      namespace: ${{ steps.create-namespace.outputs.namespace }}
      test_url: ${{ steps.get-url.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG }}

      - name: Create test namespace
        id: create-namespace
        run: |
          NAMESPACE="e2e-test-$(date +%Y%m%d-%H%M%S)"
          echo "namespace=$NAMESPACE" >> $GITHUB_OUTPUT

          kubectl create namespace $NAMESPACE
          kubectl label namespace $NAMESPACE type=e2e-test

          echo "Created namespace: $NAMESPACE"

      - name: Deploy services to test environment
        run: |
          NAMESPACE="${{ steps.create-namespace.outputs.namespace }}"

          # Create ConfigMaps and Secrets
          kubectl create configmap test-config \
            --from-literal=NODE_ENV=test \
            --from-literal=LOG_LEVEL=debug \
            -n $NAMESPACE

          # Deploy all services
          for service in api-gateway auth-service user-service product-service order-service payment-service notification-service; do
            echo "Deploying $service..."

            # Apply deployment manifests (simplified for testing)
            kubectl apply -f k8s/test/$service-deployment.yaml -n $NAMESPACE || echo "Deployment not found"
            kubectl apply -f k8s/test/$service-service.yaml -n $NAMESPACE || echo "Service not found"
          done

          # Wait for deployments to be ready
          kubectl wait --for=condition=available --timeout=10m deployment --all -n $NAMESPACE

          echo "All services deployed and ready"

      - name: Get test URL
        id: get-url
        run: |
          NAMESPACE="${{ steps.create-namespace.outputs.namespace }}"

          # Get API Gateway service endpoint
          API_GATEWAY_IP=$(kubectl get service api-gateway -n $NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "localhost")
          API_GATEWAY_PORT=$(kubectl get service api-gateway -n $NAMESPACE -o jsonpath='{.spec.ports[0].port}')

          TEST_URL="http://${API_GATEWAY_IP}:${API_GATEWAY_PORT}"
          echo "url=$TEST_URL" >> $GITHUB_OUTPUT

          echo "Test environment URL: $TEST_URL"

  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: setup-test-environment
    if: |
      always() &&
      (needs.setup-test-environment.result == 'success' || needs.setup-test-environment.result == 'skipped') &&
      (github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'smoke' || github.event_name == 'schedule')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Determine test URL
        id: url
        run: |
          if [ "${{ github.event.inputs.environment }}" == "test" ] || [ "${{ github.event_name }}" == "schedule" ]; then
            echo "url=${{ needs.setup-test-environment.outputs.test_url }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.environment }}" == "staging" ]; then
            echo "url=https://staging.app.example.com" >> $GITHUB_OUTPUT
          else
            echo "url=https://app.example.com" >> $GITHUB_OUTPUT
          fi

      - name: Run health checks
        run: |
          BASE_URL="${{ steps.url.outputs.url }}"

          echo "Testing API Gateway health..."
          curl -f "$BASE_URL/health" || exit 1

          echo "Testing Auth Service health..."
          curl -f "$BASE_URL/api/auth/health" || exit 1

          echo "Testing User Service health..."
          curl -f "$BASE_URL/api/users/health" || exit 1

          echo "Testing Product Service health..."
          curl -f "$BASE_URL/api/products/health" || exit 1

          echo "Testing Order Service health..."
          curl -f "$BASE_URL/api/orders/health" || exit 1

          echo "Testing Payment Service health..."
          curl -f "$BASE_URL/api/payments/health" || exit 1

          echo "Testing Notification Service health..."
          curl -f "$BASE_URL/api/notifications/health" || exit 1

          echo "All health checks passed"

      - name: Test user registration flow
        run: |
          BASE_URL="${{ steps.url.outputs.url }}"

          echo "Testing user registration..."
          RESPONSE=$(curl -s -X POST "$BASE_URL/api/auth/register" \
            -H "Content-Type: application/json" \
            -d '{"email":"test@example.com","password":"Test123!","name":"Test User"}')

          echo "Registration response: $RESPONSE"

          # Check if response contains expected fields
          if echo "$RESPONSE" | grep -q "token"; then
            echo "Registration successful"
          else
            echo "Registration failed"
            exit 1
          fi

      - name: Test authentication flow
        run: |
          BASE_URL="${{ steps.url.outputs.url }}"

          echo "Testing user login..."
          RESPONSE=$(curl -s -X POST "$BASE_URL/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"test@example.com","password":"Test123!"}')

          echo "Login response: $RESPONSE"

          # Extract token
          TOKEN=$(echo "$RESPONSE" | jq -r '.token')

          if [ "$TOKEN" != "null" ] && [ ! -z "$TOKEN" ]; then
            echo "Authentication successful"
            echo "TOKEN=$TOKEN" >> $GITHUB_ENV
          else
            echo "Authentication failed"
            exit 1
          fi

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [setup-test-environment, smoke-tests]
    if: |
      always() &&
      needs.smoke-tests.result == 'success' &&
      (github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'regression')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install test dependencies
        run: |
          # Create test directory if not exists
          mkdir -p tests/e2e
          cd tests/e2e

          # Install testing frameworks
          npm init -y
          npm install --save-dev jest supertest axios

      - name: Determine test URL
        id: url
        run: |
          if [ "${{ github.event.inputs.environment }}" == "test" ] || [ "${{ github.event_name }}" == "schedule" ]; then
            echo "url=${{ needs.setup-test-environment.outputs.test_url }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.environment }}" == "staging" ]; then
            echo "url=https://staging.app.example.com" >> $GITHUB_OUTPUT
          else
            echo "url=https://app.example.com" >> $GITHUB_OUTPUT
          fi

      - name: Run integration tests
        run: |
          BASE_URL="${{ steps.url.outputs.url }}"

          echo "Running integration tests..."

          # Test complete user journey
          echo "1. User Registration"
          USER_RESPONSE=$(curl -s -X POST "$BASE_URL/api/auth/register" \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"integration-test-$(date +%s)@example.com\",\"password\":\"Test123!\",\"name\":\"Integration Test\"}")

          TOKEN=$(echo "$USER_RESPONSE" | jq -r '.token')
          USER_ID=$(echo "$USER_RESPONSE" | jq -r '.user.id')

          echo "2. Get Products"
          PRODUCTS=$(curl -s "$BASE_URL/api/products" \
            -H "Authorization: Bearer $TOKEN")

          PRODUCT_ID=$(echo "$PRODUCTS" | jq -r '.[0].id')

          echo "3. Create Order"
          ORDER=$(curl -s -X POST "$BASE_URL/api/orders" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $TOKEN" \
            -d "{\"productId\":\"$PRODUCT_ID\",\"quantity\":2}")

          ORDER_ID=$(echo "$ORDER" | jq -r '.id')

          echo "4. Process Payment"
          PAYMENT=$(curl -s -X POST "$BASE_URL/api/payments" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $TOKEN" \
            -d "{\"orderId\":\"$ORDER_ID\",\"amount\":100,\"method\":\"card\"}")

          echo "5. Get Order Status"
          ORDER_STATUS=$(curl -s "$BASE_URL/api/orders/$ORDER_ID" \
            -H "Authorization: Bearer $TOKEN")

          echo "Integration tests completed successfully"

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [setup-test-environment, smoke-tests]
    if: |
      always() &&
      needs.smoke-tests.result == 'success' &&
      (github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'performance')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Determine test URL
        id: url
        run: |
          if [ "${{ github.event.inputs.environment }}" == "test" ] || [ "${{ github.event_name }}" == "schedule" ]; then
            echo "url=${{ needs.setup-test-environment.outputs.test_url }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.environment }}" == "staging" ]; then
            echo "url=https://staging.app.example.com" >> $GITHUB_OUTPUT
          else
            echo "url=https://app.example.com" >> $GITHUB_OUTPUT
          fi

      - name: Create k6 test script
        run: |
          cat << 'EOF' > load-test.js
          import http from 'k6/http';
          import { check, sleep } from 'k6';

          export let options = {
            stages: [
              { duration: '2m', target: 10 },
              { duration: '5m', target: 50 },
              { duration: '2m', target: 100 },
              { duration: '5m', target: 100 },
              { duration: '2m', target: 0 },
            ],
            thresholds: {
              http_req_duration: ['p(95)<500', 'p(99)<1000'],
              http_req_failed: ['rate<0.1'],
            },
          };

          const BASE_URL = __ENV.BASE_URL;

          export default function () {
            // Test health endpoint
            let healthRes = http.get(`${BASE_URL}/health`);
            check(healthRes, {
              'health check status is 200': (r) => r.status === 200,
            });

            // Test product listing
            let productsRes = http.get(`${BASE_URL}/api/products`);
            check(productsRes, {
              'products status is 200': (r) => r.status === 200,
              'products response time < 500ms': (r) => r.timings.duration < 500,
            });

            sleep(1);
          }
          EOF

      - name: Run load tests
        run: |
          BASE_URL="${{ steps.url.outputs.url }}"
          k6 run --env BASE_URL=$BASE_URL load-test.js --out json=load-test-results.json

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-results
          path: load-test-results.json
          retention-days: 30

  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [smoke-tests, integration-tests, performance-tests]
    if: always()

    permissions:
      issues: write

    steps:
      - name: Generate test report
        run: |
          cat << EOF > test-report.md
          ## E2E Test Report - $(date +%Y-%m-%d)

          ### Test Results

          | Test Suite | Status | Duration |
          |------------|--------|----------|
          | Smoke Tests | ${{ needs.smoke-tests.result }} | - |
          | Integration Tests | ${{ needs.integration-tests.result }} | - |
          | Performance Tests | ${{ needs.performance-tests.result }} | - |

          ### Environment
          - **Environment:** ${{ github.event.inputs.environment || 'test' }}
          - **Workflow Run:** [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          *Automated E2E tests completed*
          EOF

          cat test-report.md

      - name: Upload test report
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-report
          path: test-report.md
          retention-days: 30

  cleanup-test-environment:
    name: Cleanup Test Environment
    runs-on: ubuntu-latest
    needs: [setup-test-environment, test-report]
    if: always() && needs.setup-test-environment.result == 'success'

    steps:
      - name: Configure kubectl
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG }}

      - name: Delete test namespace
        run: |
          NAMESPACE="${{ needs.setup-test-environment.outputs.namespace }}"

          if [ ! -z "$NAMESPACE" ]; then
            echo "Deleting test namespace: $NAMESPACE"
            kubectl delete namespace $NAMESPACE --timeout=5m || echo "Failed to delete namespace"
          fi

          echo "Test environment cleanup completed"

  notify-test-results:
    name: Notify Test Results
    runs-on: ubuntu-latest
    needs: [test-report]
    if: always() && github.event_name == 'schedule'

    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.smoke-tests.result }}" == "success" ] && \
             [ "${{ needs.integration-tests.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=✅" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=❌" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        if: vars.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "${{ steps.status.outputs.emoji }} E2E Tests Completed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*E2E Test Results*\n\nStatus: ${{ steps.status.outputs.status }}\nDate: $(date +%Y-%m-%d)"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Report"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
