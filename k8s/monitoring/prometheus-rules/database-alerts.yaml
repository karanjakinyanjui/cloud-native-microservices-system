apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-database-alerts
  namespace: monitoring
  labels:
    app: prometheus
    component: monitoring
data:
  database-alerts.yaml: |
    groups:
      - name: database_health
        interval: 30s
        rules:
          # Database is down
          - alert: DatabaseDown
            expr: up{job=~".*-db"} == 0
            for: 1m
            labels:
              severity: critical
              component: database
            annotations:
              summary: "Database {{ $labels.job }} is down"
              description: "PostgreSQL database {{ $labels.job }} has been down for more than 1 minute."

          # Too many connections
          - alert: DatabaseTooManyConnections
            expr: |
              pg_stat_database_numbackends{job=~".*-db"}
              /
              pg_settings_max_connections{job=~".*-db"} * 100 > 80
            for: 5m
            labels:
              severity: warning
              component: database
            annotations:
              summary: "Database {{ $labels.job }} has too many connections"
              description: "Database {{ $labels.job }} is using {{ $value | humanize }}% of max connections."

          # Critical connection count
          - alert: DatabaseConnectionsCritical
            expr: |
              pg_stat_database_numbackends{job=~".*-db"}
              /
              pg_settings_max_connections{job=~".*-db"} * 100 > 95
            for: 2m
            labels:
              severity: critical
              component: database
            annotations:
              summary: "Database {{ $labels.job }} connection count critical"
              description: "Database {{ $labels.job }} is using {{ $value | humanize }}% of max connections."

          # Low cache hit ratio
          - alert: DatabaseLowCacheHitRatio
            expr: |
              (
                pg_stat_database_blks_hit{job=~".*-db"}
                /
                (pg_stat_database_blks_hit{job=~".*-db"} + pg_stat_database_blks_read{job=~".*-db"})
              ) * 100 < 90
            for: 10m
            labels:
              severity: warning
              component: database
            annotations:
              summary: "Low cache hit ratio on {{ $labels.job }}"
              description: "Database {{ $labels.job }} has cache hit ratio of {{ $value | humanize }}% (threshold: 90%)."

          # High transaction rollback rate
          - alert: DatabaseHighRollbackRate
            expr: |
              (
                rate(pg_stat_database_xact_rollback{job=~".*-db"}[5m])
                /
                (rate(pg_stat_database_xact_commit{job=~".*-db"}[5m]) + rate(pg_stat_database_xact_rollback{job=~".*-db"}[5m]))
              ) * 100 > 10
            for: 5m
            labels:
              severity: warning
              component: database
            annotations:
              summary: "High rollback rate on {{ $labels.job }}"
              description: "Database {{ $labels.job }} has {{ $value | humanize }}% transaction rollback rate."

          # Database size growing rapidly
          - alert: DatabaseGrowingRapidly
            expr: |
              predict_linear(pg_database_size_bytes{job=~".*-db"}[1h], 24 * 3600)
              >
              pg_database_size_bytes{job=~".*-db"} * 1.5
            for: 10m
            labels:
              severity: warning
              component: database
            annotations:
              summary: "Database {{ $labels.job }} growing rapidly"
              description: "Database {{ $labels.job }}/{{ $labels.datname }} is predicted to grow by >50% in the next 24 hours."

          # Long running queries
          - alert: DatabaseLongRunningQueries
            expr: pg_stat_activity_max_tx_duration{job=~".*-db"} > 300
            for: 5m
            labels:
              severity: warning
              component: database
            annotations:
              summary: "Long running query on {{ $labels.job }}"
              description: "Database {{ $labels.job }} has a query running for {{ $value | humanize }} seconds."

          # Deadlocks detected
          - alert: DatabaseDeadlocks
            expr: rate(pg_stat_database_deadlocks{job=~".*-db"}[5m]) > 0
            for: 5m
            labels:
              severity: warning
              component: database
            annotations:
              summary: "Deadlocks detected on {{ $labels.job }}"
              description: "Database {{ $labels.job }} is experiencing {{ $value | humanize }} deadlocks/sec."

          # Replication lag (if using replication)
          - alert: DatabaseReplicationLag
            expr: pg_replication_lag{job=~".*-db"} > 30
            for: 5m
            labels:
              severity: warning
              component: database
            annotations:
              summary: "Replication lag on {{ $labels.job }}"
              description: "Database {{ $labels.job }} replication is lagging by {{ $value | humanize }} seconds."

          # Database disk usage high
          - alert: DatabaseDiskUsageHigh
            expr: |
              (
                pg_database_size_bytes{job=~".*-db"}
                /
                (kubelet_volume_stats_capacity_bytes{persistentvolumeclaim=~".*-db-.*"})
              ) * 100 > 80
            for: 10m
            labels:
              severity: warning
              component: database
            annotations:
              summary: "High disk usage for {{ $labels.job }}"
              description: "Database {{ $labels.job }} is using {{ $value | humanize }}% of allocated disk space."

          # Slow queries
          - alert: DatabaseSlowQueries
            expr: |
              rate(pg_stat_statements_mean_time_seconds{job=~".*-db"}[5m]) > 1
            for: 10m
            labels:
              severity: warning
              component: database
            annotations:
              summary: "Slow queries on {{ $labels.job }}"
              description: "Database {{ $labels.job }} has queries with mean execution time of {{ $value | humanize }}s."

          # High temp file usage
          - alert: DatabaseHighTempFileUsage
            expr: rate(pg_stat_database_temp_bytes{job=~".*-db"}[5m]) > 100000000
            for: 10m
            labels:
              severity: warning
              component: database
            annotations:
              summary: "High temp file usage on {{ $labels.job }}"
              description: "Database {{ $labels.job }} is writing {{ $value | humanize }}B/s to temp files, indicating insufficient work_mem."
