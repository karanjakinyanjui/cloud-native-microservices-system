---
# Allow all traffic within the mesh by default (can be made more restrictive)
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-all-mesh-traffic
  namespace: default
  labels:
    app: microservices
spec:
  action: ALLOW
  rules:
  - from:
    - source:
        principals: ["cluster.local/*"]
---
# Allow ingress gateway to access frontend and API gateway
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-ingress-to-public-services
  namespace: default
  labels:
    app: microservices
spec:
  selector:
    matchLabels:
      app: frontend
  action: ALLOW
  rules:
  - from:
    - source:
        namespaces: ["istio-system"]
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-ingress-to-api-gateway
  namespace: default
  labels:
    app: microservices
spec:
  selector:
    matchLabels:
      app: api-gateway
  action: ALLOW
  rules:
  - from:
    - source:
        namespaces: ["istio-system"]
  - from:
    - source:
        principals: ["cluster.local/ns/default/sa/frontend"]
---
# Deny direct external access to internal services
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: deny-external-to-internal-services
  namespace: default
  labels:
    app: microservices
spec:
  selector:
    matchLabels:
      tier: backend
  action: DENY
  rules:
  - from:
    - source:
        notNamespaces: ["default", "istio-system"]
---
# Allow API Gateway to access all backend services
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-api-gateway-to-services
  namespace: default
  labels:
    app: microservices
spec:
  action: ALLOW
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/default/sa/api-gateway"]
    to:
    - operation:
        methods: ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"]
---
# Allow auth-service to access user-service
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-auth-to-user-service
  namespace: default
  labels:
    app: microservices
spec:
  selector:
    matchLabels:
      app: user-service
  action: ALLOW
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/default/sa/auth-service"]
    to:
    - operation:
        methods: ["GET", "POST"]
---
# Allow order-service to access payment and notification services
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-order-to-payment-notification
  namespace: default
  labels:
    app: microservices
spec:
  action: ALLOW
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/default/sa/order-service"]
    to:
    - operation:
        methods: ["POST", "GET"]
        paths: ["/payments/*", "/notifications/*"]
---
# Allow payment-service to access notification-service
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-payment-to-notification
  namespace: default
  labels:
    app: microservices
spec:
  selector:
    matchLabels:
      app: notification-service
  action: ALLOW
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/default/sa/payment-service"]
    to:
    - operation:
        methods: ["POST"]
---
# Allow health checks from anywhere
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-health-checks
  namespace: default
  labels:
    app: microservices
spec:
  action: ALLOW
  rules:
  - to:
    - operation:
        methods: ["GET"]
        paths: ["/health", "/healthz", "/ready", "/readyz", "/metrics"]
---
# Deny all policy for specific sensitive endpoints (example)
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: deny-admin-endpoints
  namespace: default
  labels:
    app: microservices
spec:
  action: DENY
  rules:
  - to:
    - operation:
        paths: ["/admin/*", "/debug/*"]
    when:
    - key: request.headers[x-admin-token]
      notValues: ["*"]
